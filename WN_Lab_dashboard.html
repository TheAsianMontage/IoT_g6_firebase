<!DOCTYPE html>
<html>
  <head>
    <title>Real Time Sensor Data</title>
    <style>
      body {
        text-align: center;
        font-family: Arial, sans-serif;
      }
      .sensor-value {
        font-size: 22px;
        margin: 10px 0;
      }
      .chart-box {
        margin: 30px auto;
        width: 80%;
      }
    </style>

    <!-- FusionCharts -->
    <script src="https://static.fusioncharts.com/code/latest/fusioncharts.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-database.js"></script>

    <!-- Firebase Init -->
    <script>
      var config = {
        apiKey: "AIzaSyBjSY0BVMxlDqXiWRlicJvYqiT_OnnfU4A",
        authDomain: "iot-g6-49f20.firebaseapp.com",
        databaseURL: "https://iot-g6-49f20-default-rtdb.firebaseio.com",
        projectId: "iot-g6-49f20",
        storageBucket: "iot-g6-49f20.appspot.com",
        messagingSenderId: "62303799348",
      };
      firebase.initializeApp(config);
      const database = firebase.database().ref("Arduino/Data");
    </script>

    <script>
      let tempChart, humChart;

      // Sort and prepare temperature data
      function prepareTempData(dataObj) {
        const tempData = [];
        for (let key in dataObj) {
          if (dataObj.hasOwnProperty(key)) {
            tempData.push({
              label: key,
              value: dataObj[key]["temp"]
            });
          }
        }
        tempData.sort((a, b) => a.label.localeCompare(b.label));
        return tempData;
      }

      // Sort and prepare humidity data
      function prepareHumData(dataObj) {
        const humData = [];
        for (let key in dataObj) {
          if (dataObj.hasOwnProperty(key)) {
            humData.push({
              label: key,
              value: dataObj[key]["hum"]
            });
          }
        }
        humData.sort((a, b) => a.label.localeCompare(b.label));
        return humData;
      }

      // Initialize both charts
      function initCharts(data) {
        const tempData = prepareTempData(data);
        const humData = prepareHumData(data);

        tempChart = new FusionCharts({
          type: "line",
          renderAt: "temp-chart",
          width: "750",
          height: "400",
          dataFormat: "json",
          dataSource: {
            chart: {
              caption: "Temperature Readings",
              xAxisName: "Timestamp",
              yAxisName: "Temperature (°C)",
              numberSuffix: "°C",
              theme: "fusion",
              showValues: "0"
            },
            data: tempData
          }
        }).render();

        humChart = new FusionCharts({
          type: "line",
          renderAt: "hum-chart",
          width: "750",
          height: "400",
          dataFormat: "json",
          dataSource: {
            chart: {
              caption: "Humidity Readings",
              xAxisName: "Timestamp",
              yAxisName: "Humidity (%)",
              numberSuffix: "%",
              theme: "fusion",
              showValues: "0"
            },
            data: humData
          }
        }).render();
      }

      // Update both charts and text
      function updateCharts(data) {
        const sortedKeys = Object.keys(data).sort();
        const latestKey = sortedKeys[sortedKeys.length - 1];
        const latestTemp = data[latestKey]?.temp;
        const latestHum = data[latestKey]?.hum;

        document.getElementById("temperature").innerText = "Latest Temperature: " + latestTemp + "°C";
        document.getElementById("humidity").innerText = "Latest Humidity: " + latestHum + "%";

        const tempData = prepareTempData(data);
        const humData = prepareHumData(data);

        if (tempChart && humChart) {
          tempChart.setJSONData({
            chart: tempChart.args.dataSource.chart,
            data: tempData
          });

          humChart.setJSONData({
            chart: humChart.args.dataSource.chart,
            data: humData
          });
        } else {
          initCharts(data);
        }
      }

      // Listen to Firebase in real-time
      window.addEventListener("load", function () {
        database.on("value", function (snapshot) {
          const data = snapshot.val();
          if (data) {
            updateCharts(data);
          }
        });
      });
    </script>
  </head>

  <body>
    <h2>Real-Time Sensor Dashboard</h2>
    <div class="sensor-value" id="temperature">Loading temperature...</div>
    <div class="sensor-value" id="humidity">Loading humidity...</div>

    <div class="chart-box">
      <div id="temp-chart"></div>
    </div>

    <div class="chart-box">
      <div id="hum-chart"></div>
    </div>
  </body>
</html>

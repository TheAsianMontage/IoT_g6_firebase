<!DOCTYPE html>
<html>
  <head>
    <title>Real Time Sensor Dashboard</title>
    <style>
      body {
        text-align: center;
        font-family: Arial, sans-serif;
      }
      .sensor-value {
        font-size: 22px;
        margin: 10px 0;
      }
      .chart-box {
        margin: 30px auto;
        width: 80%;
      }
    </style>

    <!-- FusionCharts -->
    <script src="https://static.fusioncharts.com/code/latest/fusioncharts.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-database.js"></script>

    <!-- Firebase Init -->
    <script>
      var config = {
        apiKey: "AIzaSyBjSY0BVMxlDqXiWRlicJvYqiT_OnnfU4A",
        authDomain: "iot-g6-49f20.firebaseapp.com",
        databaseURL: "https://iot-g6-49f20-default-rtdb.firebaseio.com",
        projectId: "iot-g6-49f20",
        storageBucket: "iot-g6-49f20.appspot.com",
        messagingSenderId: "62303799348",
      };
      firebase.initializeApp(config);
      const liveRef = firebase.database().ref("Arduino/Data");
      const predictionRef = firebase.database().ref("Arduino/Predictions");
    </script>

    <script>
      let tempChart, humChart, co2Chart, pmChart;
      let predTempChart, predHumChart, predCo2Chart, predPmChart;

      function prepareData(dataObj, keyName) {
        const data = [];
        for (let key in dataObj) {
          if (dataObj.hasOwnProperty(key)) {
            data.push({
              label: key,
              value: dataObj[key][keyName]
            });
          }
        }
        data.sort((a, b) => a.label.localeCompare(b.label));
        return data.slice(-25); // Keep last 25 only
      }

      function initChart(renderAt, caption, xName, yName, suffix, dataArr) {
        return new FusionCharts({
          type: "line",
          renderAt: renderAt,
          width: "750",
          height: "400",
          dataFormat: "json",
          dataSource: {
            chart: {
              caption: caption,
              xAxisName: xName,
              yAxisName: yName,
              numberSuffix: suffix,
              theme: "fusion",
              showValues: "0"
            },
            data: dataArr
          }
        }).render();
      }

      function updateChart(chart, caption, dataArr) {
        chart.setJSONData({
          chart: chart.args.dataSource.chart,
          data: dataArr
        });
      }

      function initAllCharts(liveData, predData) {
        // LIVE CHARTS
        tempChart = initChart("temp-chart", "Temperature Readings", "Timestamp", "Temperature (°C)", "°C", prepareData(liveData, "temp"));
        humChart = initChart("hum-chart", "Humidity Readings", "Timestamp", "Humidity (%)", "%", prepareData(liveData, "hum"));
        co2Chart = initChart("co2-chart", "CO2 Readings", "Timestamp", "CO2 (ppm)", " ppm", prepareData(liveData, "CO2"));
        pmChart = initChart("pm-chart", "Particulate Matter (PM) Readings", "Timestamp", "PM Level", "", prepareData(liveData, "PM"));

        // PREDICTIVE CHARTS
        predTempChart = initChart("pred-temp-chart", "Predicted Temperature", "Timestamp", "Temp (°C)", "°C", prepareData(predData, "temp"));
        predHumChart = initChart("pred-hum-chart", "Predicted Humidity", "Timestamp", "Humidity (%)", "%", prepareData(predData, "hum"));
        predCo2Chart = initChart("pred-co2-chart", "Predicted CO2", "Timestamp", "CO2 (ppm)", " ppm", prepareData(predData, "CO2"));
        predPmChart = initChart("pred-pm-chart", "Predicted PM", "Timestamp", "PM Level", "", prepareData(predData, "PM"));
      }

      function updateAllCharts(liveData, predData) {
        const sortedKeys = Object.keys(liveData).sort();
        const latestKey = sortedKeys[sortedKeys.length - 1];
        const latest = liveData[latestKey];

        document.getElementById("temperature").innerText = "Latest Temperature: " + latest?.temp + "°C";
        document.getElementById("humidity").innerText = "Latest Humidity: " + latest?.hum + "%";
        document.getElementById("co2").innerText = "Latest CO2: " + latest?.CO2 + " ppm";
        document.getElementById("pm").innerText = "Latest PM: " + latest?.PM;

        // Prepare live data
        const tempData = prepareData(liveData, "temp");
        const humData = prepareData(liveData, "hum");
        const co2Data = prepareData(liveData, "CO2");
        const pmData = prepareData(liveData, "PM");

        // Prepare prediction data
        const predTempData = prepareData(predData, "temp");
        const predHumData = prepareData(predData, "hum");
        const predCo2Data = prepareData(predData, "CO2");
        const predPmData = prepareData(predData, "PM");

        if (tempChart && predTempChart) {
          updateChart(tempChart, "Temperature Readings", tempData);
          updateChart(humChart, "Humidity Readings", humData);
          updateChart(co2Chart, "CO2 Readings", co2Data);
          updateChart(pmChart, "PM Readings", pmData);

          updateChart(predTempChart, "Predicted Temperature", predTempData);
          updateChart(predHumChart, "Predicted Humidity", predHumData);
          updateChart(predCo2Chart, "Predicted CO2", predCo2Data);
          updateChart(predPmChart, "Predicted PM", predPmData);
        } else {
          initAllCharts(liveData, predData);
        }
      }

      window.addEventListener("load", function () {
        let liveDataCache = {};
        let predDataCache = {};

        function tryUpdate() {
          if (Object.keys(liveDataCache).length > 0 && Object.keys(predDataCache).length > 0) {
            updateAllCharts(liveDataCache, predDataCache);
          }
        }

        liveRef.on("value", function (snapshot) {
          const data = snapshot.val();
          if (data) {
            liveDataCache = data;
            tryUpdate();
          }
        });

        predictionRef.on("value", function (snapshot) {
          const data = snapshot.val();
          if (data) {
            predDataCache = data;
            tryUpdate();
          }
        });
      });
    </script>
  </head>

  <body>
    <h2>Real-Time Sensor Dashboard</h2>

    <div class="sensor-value" id="temperature">Loading temperature...</div>
    <div class="sensor-value" id="humidity">Loading humidity...</div>
    <div class="sensor-value" id="co2">Loading CO2...</div>
    <div class="sensor-value" id="pm">Loading PM...</div>

    <!-- Live Charts -->
    <div class="chart-box" id="temp-chart"></div>
    <div class="chart-box" id="hum-chart"></div>
    <div class="chart-box" id="co2-chart"></div>
    <div class="chart-box" id="pm-chart"></div>

    <!-- Predictive Charts -->
    <h2>Predicted Sensor Readings</h2>
    <div class="chart-box" id="pred-temp-chart"></div>
    <div class="chart-box" id="pred-hum-chart"></div>
    <div class="chart-box" id="pred-co2-chart"></div>
    <div class="chart-box" id="pred-pm-chart"></div>
  </body>
</html>
